VPATH = $(PWD)/cint:$(PWD)/src:$(PWD)/lib:$(PWD)/rbgui
SRC=$(PWD)/src
CINT=$(PWD)/cint
USER=$(PWD)/user
ROOTFLAGS=`root-config --cflags --libs`
DYLIB=-dynamiclib -single_module -undefined dynamic_lookup 
INCFLAGS=-I$(SRC) -I$(CINT) -I$(USER) $(USER_INCLUDES)
CXXFLAGS=$(INCFLAGS) -L$(PWD)/lib -DDATA_TYPE=$(DATATYPE)

### Include the user-defined portion of the makefile
include $(PWD)/user/Makefile.user




#### MAIN PROGRAM ####
all: rootbeer


rootbeer: libHist.so libRootbeer.so $(SRC)/main.cc 
	g++ $(CXXFLAGS) -lRootbeer $(SRC)/main.cc -o rootbeer $(ROOTFLAGS)


#### ROOTBEER LIBRARY ####
SOURCES=$(SRC)/Rootbeer.cxx $(SRC)/Data.cxx $(PWD)/user/Skeleton.cxx $(SRC)/Attach.cxx $(SRC)/Canvas.cxx $(SRC)/WriteConfig.cxx \
$(SRC)/midas/TMidasEvent.cxx $(SRC)/midas/rbMidasEvent.cxx $(USER_SOURCES)

HEADERS=$(SRC)/Rootbeer.hxx $(SRC)/Data.hxx $(SRC)/midas/rbMidasEvent.h $(USER_HEADERS)

libRootbeer.so: libHist.so cint/RBDictionary.cxx $(SOURCES)
	g++ $(CXXFLAGS) -lHist -o $(PWD)/lib/$@ $(ROOTFLAGS) -lThread $(DYLIB) -p cint/RBDictionary.cxx $(SOURCES)


cint/RBDictionary.cxx: $(HEADERS) Linkdef.h
	rootcint -f $@ -c $(CXXFLAGS)  -p $^



#### COMPILE HISTOGRAM LIBRARY ####

libHist.so: Hist.cxx cint/HistDictionary.cxx
	g++ -o $(PWD)/lib/$@ $(CXXFLAGS) $(ROOTFLAGS) -lTreePlayer $(DYLIB) -p $^


cint/HistDictionary.cxx: Hist.hxx LockingPointer.hxx HistLinkdef.h
	rootcint -f $@ -c $(CXXFLAGS) -p $^



#### REMOVE EVERYTHING GENERATED BY MAKE ####

clean:
	rm -f lib/*.so rootbeer cint/RBDictionary.* cint/HistDictionary.* rbgui/HistDict.*



#### FOR DOXYGEN ####

doc:
	cd $(PWD)/doxygen ; doxygen Doxyfile ; cd latex; make; cd $(PWD)

doccopy:
	cd $(PWD)/doxygen ; doxygen Doxyfile ; cd latex; make; cd $(PWD) ; \
	$(PWD)/doxygen/copydoc.sh




#### GUI STUFF ####


GUI=$(PWD)/rbgui
GUIHEADERS=$(GUI)/HistViewer.h $(GUI)/HistMaker.h $(GUI)/TH2D_SF.h $(GUI)/TH1D_SF.h $(GUI)/TH3D_SF.h
GUISOURCES=$(GUI)/HistViewer.cc $(GUI)/HistMaker.cc $(GUI)/TH2D_SF.cc $(GUI)/TH1D_SF.cc $(GUI)/TH3D_SF.cc

GUIROOTFLAGS=-dynamiclib -single_module -undefined dynamic_lookup `root-config --cflags --libs` -lTreePlayer

GUICXXFLAGS=-fPIC

gui: librbgui.so

librbgui.so: libHist.so HistDict.cxx $(GUISOURCES)
	g++ -L$(PWD)/lib -lHist -shared -o $(PWD)/lib/$@ $(GUICXXFLAGS) -I/opt/local/include/root $(GUI)/HistDict.cxx $(GUISOURCES) $(GUIROOTFLAGS) -I$(PWD)/src

HistDict.cxx: $(GUIHEADERS) rbgui/Linkdef.h
	rootcint -f rbgui/$@ -c -Isrc $(GUICXXFLAGS) -p $^

#HistViewer.o:
#	g++ -c $(ROOTFLAGS) $(CXXFLAGS) HistViewer.cc

guiclean:
	rm -f lib/librbgui.so rbgui/HistDict.*
